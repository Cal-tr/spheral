# ------------------------------------------------------------------------------
# JOB TEMPLATES

.build_and_test:
  script:
    - ml load python/3.8.2
    - ml load $LC_MODULES
    - $BUILD_ALLOC ./$SCRIPT_DIR/gitlab/build_and_install.py --spec="$SPEC" --lc-modules="$LC_MODULES" --extra-cmake-args="$EXTRA_CMAKE_ARGS"
    - cat build_gitlab/install/spheral-lcatstest
    - $TEST_ALLOC ./build_gitlab/install/spheral-lcatstest --logs test-logs build_gitlab/install/$ATS_FILE
    - ./build_gitlab/install/spheral $SCRIPT_DIR/gitlab/report_results.py
  artifacts:
    when: always
    paths:
      - test-logs/

.update_tpls:
  script:
    - $BUILD_ALLOC ./$SCRIPT_DIR/devtools/tpl-manager.py --spec-list="$SCRIPT_DIR/devtools/spec-list.json" --spheral-spack-dir=$UPSTREAM_DIR

.toss_update_permissions:
  script:
    - ml load mpifileutils
    - srun -N 1 -p $PARTITION -n 20 -t 10 dchmod --mode go+rx $UPSTREAM_DIR
.merge_pr_rule:
  rules:
    - if: '$CI_COMMIT_REF_NAME == "develop"'
      when: always


